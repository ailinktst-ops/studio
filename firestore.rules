/**
 * FIRESTORE SECURITY RULES
 *
 * Core Philosophy:
 * This ruleset implements an open-read/authenticated-write model designed for a real-time 
 * counter and ranking application. The primary goal is to allow any user (including 
 * unauthenticated "overlay" views) to read data while restricting modification 
 * to authenticated users.
 *
 * Data Structure:
 * - /counters/{counterId}: The primary document containing counter metadata and denormalized participant stats.
 * - /counters/{counterId}/participants/{participantId}: Granular participant records for detailed updates.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the Counter collection. Supports public viewing for the overlay.
     */
    match /counters/{counterId} {
      allow read: if true;
      
      // Allow any authenticated user to write (create/update/delete) for the prototype.
      // Simplificado para 'write' para garantir compatibilidade com setDoc(merge: true) e evitar erros de permiss√£o.
      allow write: if isSignedIn();

      /**
       * @description Rules for participants within a specific counter.
       */
      match /participants/{participantId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
    }

  }
}