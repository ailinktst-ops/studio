/**
 * FIRESTORE SECURITY RULES
 *
 * Core Philosophy:
 * This ruleset implements an open-read/authenticated-write model designed for a real-time 
 * counter and ranking application. The primary goal is to allow any user (including 
 * unauthenticated "overlay" views) to read data while restricting modification 
 * to authenticated users.
 *
 * Data Structure:
 * - /counters/{counterId}: The primary document containing counter metadata and denormalized participant stats.
 * - /counters/{counterId}/participants/{participantId}: Granular participant records for detailed updates.
 *
 * Key Security Decisions:
 * 1. Public Visibility: To support the "overlay" requirement, all counter and participant 
 *    data is publicly readable (`allow get, list: if true`).
 * 2. Authenticated Writes: Modification is permitted for any authenticated user. 
 *    Note: The current schema does not define specific document ownership (e.g., an ownerId 
 *    field), so any logged-in user can currently modify any counter.
 * 3. Prototyping Flexibility: Security rules are simplified to allow rapid iteration 
 *    by any authenticated user (anonymous or admin).
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the Counter collection. Supports public viewing for the overlay.
     */
    match /counters/{counterId} {
      allow get, list: if true;
      
      // Allow any authenticated user to create or update for the prototype.
      allow create: if isSignedIn() && request.resource.data.id == counterId;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      /**
       * @description Rules for participants within a specific counter.
       */
      match /participants/{participantId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }

  }
}